---
title: "Исследование метаданных DNS трафика"
author: "nastya5908@yandex.ru"
editor: visual
format: 
  md:
    output-file: README.md
---

## Цель работы

1.  Закрепить практические навыки использования языка программирования R для обработки данных
2.  Закрепить знания основных функций обработки данных экосистемы tidyverse языка R
3.  Закрепить навыки исследования метаданных DNS трафика

## Исходные данные

1.  Программное обеспечение Windows 11
2.  Rstudio Desktop
3.  Интерпретатор языка R 4.5.1

## План:

1.  Импортировать и подготовить данные

2.  Проанализировать метаданные DNS трафика

3.  Составить отчет и выложить его и исходный qmd/rmd файл в свой репозиторий

## Шаги

Установим и подключим необходимые библиотеки

```{r}
library(dplyr)
```

```{r}
library(tidyverse)
```

```{r}
library(readr)
```

```{r}
library(httr)
```

#### Подготовка данных

1\. Импортируем данные DNS

```{r}
download.file("https://storage.yandexcloud.net/dataset.ctfsec/dns.zip", "dns.zip")
```

```{r}
unzip("dns.zip")
```

```{r}
dns <- read_tsv("dns.log", comment = "#", col_names = FALSE)
```

2\. Добавим пропущенные данные о структуре данных (назначении столбцов)

```{r}
col_names <- c(
  "timestamp", "uid", "source_ip", "source_port", "destination_ip", 
  "destination_port", "protocol", "transaction_id", "query", "qclass", 
  "qclass_name", "qtype", "qtype_name", "rcode", "rcode_name", 
  "AA", "TC", "RD", "RA", "Z", "answer", "TTLS", "rejected"
)
```

```{r}
colnames(dns) <- col_names
```

3\. Преобразуем данные в столбцах в нужный формат

```{r}
dns <- dns |> mutate(timestamp = as_datetime(timestamp),
                      source_port = as.numeric(source_port),
                      qclass = as.numeric(qclass),
                      qtype = as.numeric(qtype))
```

Посмотрим общую структуру данных

```{r}
glimpse(dns)
```

#### Анализ

4\. Сколько участников информационного обмена в сети Доброй Организации?

```{r}
length(unique(c(dns$source_ip, dns$destination_ip)))
```

5\. Какое соотношение участников обмена внутри сети и участников обращений к внешним ресурсам?

```{r}
un_ip <- unique(c(dns$source_ip, dns$destination_ip))
int_ip <- un_ip[grepl("^(10\\.|192\\.168\\.|172\\.(1[6-9]|2[0-9]|3[0-1])\\.)", un_ip)]
ext_ip <- un_ip[!grepl("^(10\\.|192\\.168\\.|172\\.(1[6-9]|2[0-9]|3[0-1])\\.)", un_ip)]
length(int_ip)/length(ext_ip)
```

6\. Найдите топ-10 участников сети, проявляющих наибольшую сетевую активность.

```{r}
dns |> count(source_ip, sort = TRUE) |> head(10)
```

7\. Найдите топ-10 доменов, к которым обращаются пользователи сети и соответственное количество обращений

```{r}
dns |> count(query, sort = TRUE) |> head(10)
```

8\. Опеределите базовые статистические характеристики (функция summary() ) интервала времени между последовательными обращениями к топ-10 доменам.

```{r}
top_10_dom <- dns |> count(query, sort = TRUE) |> head(10) |> pull(query)
dns |> filter(query %in% top_10_dom) |>
     arrange(timestamp) |> group_by(query) |>
     mutate(time = lead(timestamp) - timestamp) |>
     filter(!is.na(time))|>
     summarise(
         min = min(time),
         Q1 = quantile(time, 0.25),
         median = median(time),
         Q3 = quantile(time, 0.75),
         max = max(time),
         mean = mean(time)
     )
```

9\. Часто вредоносное программное обеспечение использует DNS канал в качестве канала управления, периодически отправляя запросы на подконтрольный злоумышленникам DNS сервер. По периодическим запросам на один и тот же домен можно выявить скрытый DNS канал. Есть ли такие IP адреса в исследуемом датасете?

```{r}
dns |>
  arrange(source_ip, query, timestamp) |>
  group_by(source_ip, query) |>
  mutate(time = as.numeric(lead(timestamp) - timestamp)) |>
  filter(!is.na(time)) |>
  summarise(requests = n() + 1,
    avg_interval = mean(time)) |>
  filter(requests >= 10, avg_interval <= 30) |>
  group_by(source_ip) |>
  summarise(
    pd_domains = n(),
    total_requests = sum(requests),
  ) |>
  arrange(desc(pd_domains))
```

#### Обогащение данных

10\. Определите местоположение (страну, город) и организацию-провайдера для топ-10 доменов. Для этого можно использовать сторонние сервисы, например http://ip-api.com (API-эндпоинт – http://ip-api.com/json).

```{r}
top_10_dom <- dns |> count(query, sort = TRUE) |> head(10) |> pull(query)

get_geo <- function(query) {
  tryCatch({
    response <- GET(paste0("http://ip-api.com/json/", query))
    data <- content(response, "parsed")
    return(list(
      query=query,
      ip = data$query %||% NA,
      country = data$country %||% NA,
      city = data$city %||% NA, 
      isp = data$isp %||% NA
    ))
  }, error = function(e) {
    return(list(ip = NA, country = NA, city = NA, isp = NA))
  })
}
results <- map_dfr(top_10_dom, function(query) {
  geo <- get_geo(query)
})

print(results)
```
## Вывод
В результате выполнения работы были закреплены знания основных функций обработки данных экосистемы tidyverse и получены навыки исследования метаданных DNS трафика